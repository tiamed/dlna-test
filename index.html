<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <title>DLNAæŠ•å±æ§åˆ¶ä¸­å¿ƒ</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <style>
            :root {
                --primary: #2196f3;
                --error: #f44336;
                --background: #f5f5f5;
            }
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 20px auto;
                padding: 20px;
                background: var(--background);
            }
            .device-card {
                background: white;
                border-radius: 8px;
                padding: 15px;
                margin: 10px 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                cursor: pointer;
                transition: transform 0.2s;
            }
            .device-card.selected {
                border: 2px solid var(--primary);
                transform: translateX(5px);
            }
            .device-icon {
                font-size: 24px;
                margin-right: 15px;
            }
            #mediaUrl {
                width: 100%;
                padding: 12px;
                border: 1px solid #ddd;
                border-radius: 6px;
                margin: 15px 0;
            }
            button {
                background: var(--primary);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                cursor: pointer;
                width: 100%;
                font-size: 16px;
            }
            .toast {
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: #323232;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                opacity: 0;
                transition: opacity 0.3s;
            }
            .toast.visible {
                opacity: 1;
            }
            .toast.error {
                background: var(--error);
            }
        </style>
    </head>
    <body>
        <h1>DLNAæŠ•å±æ§åˆ¶</h1>
        <button
            type="button"
            onclick="discoverDevices()"
            aria-label="åˆ·æ–°è®¾å¤‡åˆ—è¡¨"
        >
            ğŸ”„ åˆ·æ–°è®¾å¤‡åˆ—è¡¨
        </button>

        <div id="devicesContainer"></div>

        <label style="display: block; margin: 15px 0">
            <input
                type="text"
                id="mediaUrl"
                placeholder="è¾“å…¥åª’ä½“åœ°å€ (ä¾‹: https://example.com/video.mp4)"
                aria-label="åª’ä½“æ–‡ä»¶åœ°å€"
            />
        </label>

        <button onclick="playMedia()">ğŸš€ å¼€å§‹æŠ•å±</button>

        <div id="toast" class="toast"></div>

        <script>
            let ws = null;
            let selectedDevice = null;
            let devices = [];

            // Toastæç¤ºç³»ç»Ÿ
            function showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} visible`;
                setTimeout(() => toast.classList.remove('visible'), 3000);
            }

            // WebSocketåˆå§‹åŒ–
            function initWebSocket() {
                if (ws) return;

                const protocol =
                    window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const host = window.location.hostname || 'localhost';
                ws = new WebSocket(`${protocol}//${host}:3000`);

                ws.onopen = () => {
                    showToast('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                    discoverDevices();
                };

                ws.onmessage = (event) => {
                    const { type, data } = JSON.parse(event.data);
                    if (type === 'devices') {
                        devices = data;
                        renderDevices();
                    } else if (type === 'result') {
                        showToast(
                            data.success ? 'æŠ•å±æˆåŠŸ' : 'æŠ•å±å¤±è´¥',
                            data.success ? 'info' : 'error',
                        );
                    } else if (type === 'error') {
                        showToast(`é”™è¯¯: ${data}`, 'error');
                    }
                };

                ws.onerror = (error) => {
                    showToast('è¿æ¥æœåŠ¡å™¨å¤±è´¥', 'error');
                };
            }

            // æ¸²æŸ“è®¾å¤‡åˆ—è¡¨
            function renderDevices() {
                const container = document.getElementById('devicesContainer');
                container.innerHTML =
                    devices
                        .map(
                            (device) => `
        <div class="device-card ${
            selectedDevice?.controlURL === device.controlURL ? 'selected' : ''
        }" 
             onclick="selectDevice('${device.controlURL}')">
          <div style="display: flex; align-items: center;">
            <span class="device-icon">${getDeviceIcon(device.type)}</span>
            <div>
              <div>${device.name}</div>
              <div style="color: #666; font-size: 0.9em;">${device.ip}</div>
              <div style="color: #999; font-size: 0.8em;">${
                  device.controlURL
              }</div>
            </div>
          </div>
        </div>
      `,
                        )
                        .join('') ||
                    '<div style="text-align: center; color: #666;">æœªå‘ç°è®¾å¤‡</div>';
            }

            // è®¾å¤‡é€‰æ‹©
            function selectDevice(controlURL) {
                selectedDevice = devices.find(
                    (d) => d.controlURL === controlURL,
                );
                renderDevices();
            }

            // è®¾å¤‡å›¾æ ‡
            function getDeviceIcon(type) {
                const icons = {
                    MediaRenderer: 'ğŸ“º',
                    DMR: 'ğŸ–¥ï¸',
                    Speaker: 'ğŸ”Š',
                };
                return icons[type] || 'ğŸ®';
            }

            // å‘ç°è®¾å¤‡
            function discoverDevices() {
                if (!ws || ws.readyState !== WebSocket.OPEN) return;
                selectedDevice = null;
                ws.send(JSON.stringify({ type: 'discover' }));
            }

            // æŠ•å±æ“ä½œ
            function handlePlayResponse(response) {
                if (response.error) {
                    showToast(`æŠ•å±å¤±è´¥: ${response.error}`, 'error');
                    return;
                }
                showToast('æŠ•å±æˆåŠŸï¼Œåª’ä½“æ­£åœ¨åŠ è½½...');
                console.log('æ’­æ”¾ä¼šè¯ID:', response.sessionId);
            }

            function playMedia() {
                if (!selectedDevice) {
                    showToast('è¯·å…ˆé€‰æ‹©è®¾å¤‡', 'error');
                    return;
                }

                const mediaURL = document
                    .getElementById('mediaUrl')
                    .value.trim();
                if (!mediaURL.startsWith('http')) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆURL', 'error');
                    return;
                }

                ws.send(
                    JSON.stringify({
                        type: 'play',
                        data: {
                            location: selectedDevice.location,
                            mediaURL: mediaURL,
                        },
                    }),
                );
            }

            // åˆå§‹åŒ–
            window.onload = initWebSocket;
        </script>
    </body>
</html>
